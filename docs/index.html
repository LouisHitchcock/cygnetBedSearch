<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bed Data Tracker</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
    <h1>Bed Data Tracker</h1>
    <canvas id="bedChart" width="400" height="200"></canvas>
    <table id="bedTable">
        <thead>
            <tr>
                <th>Name</th>
                <th>Location</th>
                <th>Gender</th>
                <th>Purpose</th>
                <th>Beds</th>
                <th>Last Updated</th>
                <th>Changes in 24hrs</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <script>
        function getChangeCount(currentData, previousData) {
            const changeCounts = currentData.map((row) => {
                const prevRow = previousData.find(prev => prev[0] === row[0]);
                if (prevRow) {
                    const currentTime = new Date(row[5]);
                    const previousTime = new Date(prevRow[5]);
                    const timeDiff = Math.abs(currentTime - previousTime) / 36e5; // Difference in hours
                    if (timeDiff <= 24) {
                        return Math.abs(row[4] - prevRow[4]);
                    }
                }
                return 0;
            });
            return changeCounts;
        }

        function sortDataByChanges(currentData, changeCounts) {
            return currentData.map((row, index) => [...row, changeCounts[index]])
                             .sort((a, b) => b[b.length - 1] - a[a.length - 1]);
        }

        function colorFromChangeCount(changeCount) {
            const maxChanges = 10; // Adjust this based on expected max changes
            const redIntensity = Math.min(255, changeCount * 25);
            return `rgb(255, ${255 - redIntensity}, ${255 - redIntensity})`;
        }

        async function fetchData() {
            const responseCurrent = await fetch('https://louishitchcock.github.io/cygnetBedSearch/bed_data.csv');
            const responseOld = await fetch('https://louishitchcock.github.io/cygnetBedSearch/old-data.csv');

            const dataCurrent = await responseCurrent.text();
            const dataOld = await responseOld.text();

            const rowsCurrent = dataCurrent.split('\n').slice(1);
            const rowsOld = dataOld.split('\n').slice(1);

            const currentData = rowsCurrent.map(row => row.split(','));
            const previousData = rowsOld.map(row => row.split(','));

            const changeCounts = getChangeCount(currentData, previousData);
            const sortedData = sortDataByChanges(currentData, changeCounts);

            const tbody = document.querySelector('#bedTable tbody');
            tbody.innerHTML = '';

            sortedData.forEach((cols, index) => {
                const tr = document.createElement('tr');
                const changeCount = cols[cols.length - 1];
                tr.style.backgroundColor = colorFromChangeCount(changeCount);

                cols.forEach((col, colIndex) => {
                    const td = document.createElement('td');
                    td.textContent = col;
                    tr.appendChild(td);
                });

                const changeTd = document.createElement('td');
                changeTd.textContent = changeCount;
                tr.appendChild(changeTd);

                tbody.appendChild(tr);
            });

            visualizeData(currentData, previousData);
        }

        function visualizeData(currentData, previousData) {
            const labels = currentData.map(row => new Date(row[5]).toLocaleString());
            const currentBeds = currentData.map(row => parseInt(row[4]));
            const oldBeds = previousData.map(row => parseInt(row[4]));

            const ctx = document.getElementById('bedChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Current Beds',
                            data: currentBeds,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        },
                        {
                            label: 'Previous Beds',
                            data: oldBeds,
                            borderColor: 'rgba(153, 102, 255, 1)',
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        }
                    ]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour'
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        fetchData();
        setInterval(fetchData, 6 * 60 * 60 * 1000); // 6 hours
    </script>
</body>
</html>
